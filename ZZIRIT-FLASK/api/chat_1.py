from flask import Blueprint, request, jsonify
import re
from gemini_handler import get_gemini_response

chat1_bp = Blueprint("chat1", __name__)

# PCB ê´€ë ¨ ì¼ë°˜ì ì¸ ì •ë³´ (DB ì ‘ê·¼ ì—†ì´ ì œê³µí•  ìˆ˜ ìˆëŠ” ì •ë³´)
PCB_INFO = {
    "components": {
        "resistor": "ì €í•­ì€ ì „ë¥˜ì˜ íë¦„ì„ ì œí•œí•˜ëŠ” ìˆ˜ë™ ì†Œìì…ë‹ˆë‹¤. ë‹¨ìœ„ëŠ” ì˜´(Î©)ì…ë‹ˆë‹¤.",
        "capacitor": "ì»¤íŒ¨ì‹œí„°ëŠ” ì „ê¸° ì—ë„ˆì§€ë¥¼ ì €ì¥í•˜ëŠ” ìˆ˜ë™ ì†Œìì…ë‹ˆë‹¤. ë‹¨ìœ„ëŠ” íŒ¨ëŸ¿(F)ì…ë‹ˆë‹¤.",
        "inductor": "ì¸ë•í„°ëŠ” ìê¸° ì—ë„ˆì§€ë¥¼ ì €ì¥í•˜ëŠ” ìˆ˜ë™ ì†Œìì…ë‹ˆë‹¤. ë‹¨ìœ„ëŠ” í—¨ë¦¬(H)ì…ë‹ˆë‹¤.",
        "diode": "ë‹¤ì´ì˜¤ë“œëŠ” í•œ ë°©í–¥ìœ¼ë¡œë§Œ ì „ë¥˜ë¥¼ í˜ë¦¬ëŠ” ë°˜ë„ì²´ ì†Œìì…ë‹ˆë‹¤.",
        "ic": "IC(ì§‘ì íšŒë¡œ)ëŠ” ì—¬ëŸ¬ ì „ì ë¶€í’ˆì´ í•˜ë‚˜ì˜ ì¹©ì— ì§‘ì ëœ ì†Œìì…ë‹ˆë‹¤."
    },
    "sizes": {
        "0402": "0.4mm Ã— 0.2mm í¬ê¸°ì˜ ì†Œí˜• SMD íŒ¨í‚¤ì§€",
        "0604": "0.6mm Ã— 0.4mm í¬ê¸°ì˜ SMD íŒ¨í‚¤ì§€",
        "1008": "1.0mm Ã— 0.8mm í¬ê¸°ì˜ SMD íŒ¨í‚¤ì§€",
        "2015": "2.0mm Ã— 1.5mm í¬ê¸°ì˜ SMD íŒ¨í‚¤ì§€",
        "2520": "2.5mm Ã— 2.0mm í¬ê¸°ì˜ SMD íŒ¨í‚¤ì§€"
    }
}

def get_service_info(query_type):
    """ì„œë¹„ìŠ¤ ê´€ë ¨ ì •ë³´ ì œê³µ"""
    service_info = {
        "login": """
ğŸ” **ë¡œê·¸ì¸ ë°©ë²•**
1. ìš°ì¸¡ ìƒë‹¨ 'ë¡œê·¸ì¸' ë²„íŠ¼ í´ë¦­
2. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
3. ë¡œê·¸ì¸ ì™„ë£Œ í›„ ëª¨ë“  ê¸°ëŠ¥ ì´ìš© ê°€ëŠ¥

âœ¨ **ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥:**
- ì‹¤ì‹œê°„ ì¬ê³  ì¡°íšŒ
- ë¶€í’ˆ ìƒì„¸ ì •ë³´ ê²€ìƒ‰
- ì¬ê³  ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ
- ë¶€í’ˆ ì£¼ë¬¸ ë° ê´€ë¦¬
- ìƒì„¸ ë¶„ì„ ë¦¬í¬íŠ¸
        """,
        
        "signup": """
ğŸ“ **íšŒì›ê°€ì… ë°©ë²•**
1. ìš°ì¸¡ ìƒë‹¨ 'íšŒì›ê°€ì…' ë²„íŠ¼ í´ë¦­
2. ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„ ì…ë ¥
3. ì•½ê´€ ë™ì˜ í›„ íšŒì›ê°€ì… ì™„ë£Œ
4. ë°”ë¡œ ë¡œê·¸ì¸í•˜ì—¬ ì„œë¹„ìŠ¤ ì´ìš© ì‹œì‘

ğŸ¯ **íšŒì›ê°€ì… í˜œíƒ:**
- ë¬´ë£Œ ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ìš©
- ì‹¤ì‹œê°„ ë¶€í’ˆ ì •ë³´ ì¡°íšŒ
- ë§ì¶¤í˜• ì¬ê³  ì•Œë¦¼ ì„œë¹„ìŠ¤
        """,
        
        "features": """
ğŸš€ **PCB-Manager ì£¼ìš” ê¸°ëŠ¥**

ğŸ“Š **ì¬ê³  ê´€ë¦¬**
- ì‹¤ì‹œê°„ ë¶€í’ˆ ì¬ê³  í˜„í™©
- ìµœì†Œ ì¬ê³ ëŸ‰ ì•Œë¦¼
- ìë™ ë°œì£¼ ì œì•ˆ

ğŸ” **ë¶€í’ˆ ê²€ìƒ‰**
- ë¶€í’ˆë²ˆí˜¸ë¡œ ì •í™•í•œ ì •ë³´ ì¡°íšŒ
- ì¹´í…Œê³ ë¦¬ë³„ ë¶€í’ˆ ë¶„ë¥˜
- ì œì¡°ì‚¬ë³„ ë¶€í’ˆ ê²€ìƒ‰

ğŸ“ˆ **ë¶„ì„ ëŒ€ì‹œë³´ë“œ**
- ì¬ê³  íŠ¸ë Œë“œ ë¶„ì„
- ì‚¬ìš©ëŸ‰ í†µê³„
- ë¹„ìš© ìµœì í™” ì œì•ˆ

ğŸ”” **ì•Œë¦¼ ì„œë¹„ìŠ¤**
- ì¬ê³  ë¶€ì¡± ì•Œë¦¼
- ì‹ ì œí’ˆ ì…ê³  ì•Œë¦¼
- ê°€ê²© ë³€ë™ ì•Œë¦¼
        """,
        
        "help": """
â“ **ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?**

ğŸ’¬ **ì§€ê¸ˆ í•  ìˆ˜ ìˆëŠ” ê²ƒ:**
- PCB ë¶€í’ˆì— ëŒ€í•œ ì¼ë°˜ì ì¸ ì§ˆë¬¸
- ì„œë¹„ìŠ¤ ê¸°ëŠ¥ ì•ˆë‚´
- ë¡œê·¸ì¸/íšŒì›ê°€ì… ë°©ë²• ì•ˆë‚´

ğŸ”’ **ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•œ ê²ƒ:**
- ì‹¤ì œ ì¬ê³  ë°ì´í„° ì¡°íšŒ
- ë¶€í’ˆ ìƒì„¸ ì •ë³´ ê²€ìƒ‰
- ì¬ê³  ê´€ë¦¬ ê¸°ëŠ¥ ì´ìš©

ğŸ“ **ë¬¸ì˜ì‚¬í•­:**
- ì´ë©”ì¼: support@pcb-manager.com
- ì „í™”: 02-1234-5678
        """,
        
        "about": """
ğŸ¢ **PCB-Manager ì†Œê°œ**

PCB-ManagerëŠ” ì „ì ë¶€í’ˆ ì¬ê³  ê´€ë¦¬ë¥¼ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ ì†”ë£¨ì…˜ì…ë‹ˆë‹¤.

ğŸ¯ **ìš°ë¦¬ì˜ ë¯¸ì…˜**
ì „ì ì œì¡°ì—…ì²´ì˜ íš¨ìœ¨ì ì¸ ë¶€í’ˆ ê´€ë¦¬ì™€ ë¹„ìš© ì ˆê°ì„ í†µí•´ 
ë” ë‚˜ì€ ì œí’ˆ ê°œë°œì— ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ ë•ìŠµë‹ˆë‹¤.

âœ¨ **í•µì‹¬ ê°€ì¹˜**
- ì •í™•í•œ ë°ì´í„° ê´€ë¦¬
- ì‹¤ì‹œê°„ ì •ë³´ ì œê³µ  
- ì‚¬ìš©ì ì¹œí™”ì  ì¸í„°í˜ì´ìŠ¤
- 24/7 ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤

ğŸ‘¥ **ëŒ€ìƒ ê³ ê°**
- ì „ì ì œí’ˆ ì œì¡°ì—…ì²´
- PCB ì„¤ê³„ ì—”ì§€ë‹ˆì–´
- ë¶€í’ˆ êµ¬ë§¤ ë‹´ë‹¹ì
- ì¬ê³  ê´€ë¦¬ì
        """
    }
    return service_info.get(query_type, "")

def analyze_user_intent(user_input):
    """ì‚¬ìš©ì ì˜ë„ ë¶„ì„"""
    input_lower = user_input.lower()
    
    # ë¡œê·¸ì¸ ê´€ë ¨
    if any(keyword in input_lower for keyword in ["ë¡œê·¸ì¸", "login", "ê³„ì •", "ì ‘ì†", "ë¡œê·¸ì¸í•˜ê¸°"]):
        return "login"
    
    # íšŒì›ê°€ì… ê´€ë ¨
    if any(keyword in input_lower for keyword in ["íšŒì›ê°€ì…", "signup", "ê°€ì…", "ê³„ì •ìƒì„±", "ë“±ë¡", "íšŒì›ê°€ì…í•˜ê¸°"]):
        return "signup"
    
    # ê¸°ëŠ¥ ì•ˆë‚´
    if any(keyword in input_lower for keyword in ["ê¸°ëŠ¥", "íŠ¹ì§•", "feature", "ì„œë¹„ìŠ¤", "ë­", "í• ìˆ˜ìˆ", "ê°€ëŠ¥", "ê¸°ëŠ¥ì†Œê°œ"]):
        return "features"
    
    # ë„ì›€ë§
    if any(keyword in input_lower for keyword in ["ë„ì›€", "help", "ì–´ë–»ê²Œ", "ë°©ë²•", "ë¬¸ì˜", "ë¬¸ì˜ì‚¬í•­"]):
        return "help"
    
    # ì„œë¹„ìŠ¤ ì†Œê°œ
    if any(keyword in input_lower for keyword in ["ì†Œê°œ", "about", "íšŒì‚¬", "pcb-manager", "ë¬´ì—‡", "ì†Œê°œí•´ì¤˜"]):
        return "about"
    
    # PCB ë¶€í’ˆ ê´€ë ¨
    if any(keyword in input_lower for keyword in ["ì €í•­", "resistor", "ì»¤íŒ¨ì‹œí„°", "capacitor", "ì¸ë•í„°", "inductor", "ë‹¤ì´ì˜¤ë“œ", "diode", "ic", "ë¶€í’ˆ", "ë¶€í’ˆì†Œê°œ"]):
        return "pcb_info"
    
    # ì‚¬ì´ì¦ˆ ê´€ë ¨
    if any(keyword in input_lower for keyword in ["0402", "0604", "1008", "2015", "2520", "ì‚¬ì´ì¦ˆ", "í¬ê¸°"]):
        return "size_info"
    
    return "general"

def get_pcb_component_info(user_input):
    """PCB ë¶€í’ˆ ê´€ë ¨ ì¼ë°˜ ì •ë³´ ì œê³µ"""
    input_lower = user_input.lower()
    
    for component, description in PCB_INFO["components"].items():
        if component in input_lower or (component == "resistor" and "ì €í•­" in input_lower):
            return f"ğŸ“± **{component.upper()}**\n{description}"
    
    for size, description in PCB_INFO["sizes"].items():
        if size in input_lower:
            return f"ğŸ“ **{size} íŒ¨í‚¤ì§€**\n{description}"
    
    return """
ğŸ”§ **PCB ë¶€í’ˆ ê¸°ë³¸ ì •ë³´**

**ì£¼ìš” ë¶€í’ˆ ì¢…ë¥˜:**
â€¢ ì €í•­ (Resistor): ì „ë¥˜ ì œí•œ
â€¢ ì»¤íŒ¨ì‹œí„° (Capacitor): ì „ê¸° ì—ë„ˆì§€ ì €ì¥  
â€¢ ì¸ë•í„° (Inductor): ìê¸° ì—ë„ˆì§€ ì €ì¥
â€¢ ë‹¤ì´ì˜¤ë“œ (Diode): ë‹¨ë°©í–¥ ì „ë¥˜ íë¦„
â€¢ IC (Integrated Circuit): ì§‘ì íšŒë¡œ

**ì¼ë°˜ì ì¸ SMD íŒ¨í‚¤ì§€:**
â€¢ 0402: 0.4mm Ã— 0.2mm
â€¢ 0604: 0.6mm Ã— 0.4mm  
â€¢ 1008: 1.0mm Ã— 0.8mm
â€¢ 2015: 2.0mm Ã— 1.5mm
â€¢ 2520: 2.5mm Ã— 2.0mm

ğŸ’¡ **ë” ìì„¸í•œ ì¬ê³  ì •ë³´ê°€ í•„ìš”í•˜ì‹œë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!**
    """

def create_enhanced_prompt(user_input, intent):
    """Geminiì—ê²Œ ë³´ë‚¼ í–¥ìƒëœ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
    
    base_context = """
ë‹¹ì‹ ì€ PCB-Manager ì„œë¹„ìŠ¤ì˜ ì¹œì ˆí•œ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

ì£¼ìš” ì—­í• :
1. PCB ë¶€í’ˆì— ëŒ€í•œ ì¼ë°˜ì ì¸ ì •ë³´ ì œê³µ
2. ì„œë¹„ìŠ¤ ì´ìš© ë°©ë²• ì•ˆë‚´ 
3. ë¡œê·¸ì¸/íšŒì›ê°€ì… ìœ ë„ (ìƒì„¸ ì •ë³´ ì¡°íšŒì‹œ)
4. ì¹œê·¼í•˜ê³  ì „ë¬¸ì ì¸ ë‹µë³€

ì œì•½ì‚¬í•­:
- ì‹¤ì œ ì¬ê³  ë°ì´í„°ëŠ” ì œê³µí•˜ì§€ ì•ŠìŒ (ë¡œê·¸ì¸ í•„ìš”)
- êµ¬ì²´ì ì¸ ë¶€í’ˆ ê°€ê²©ì´ë‚˜ ì¬ê³ ëŸ‰ì€ ë‹µë³€í•˜ì§€ ì•ŠìŒ
- ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•¨ì„ ì•ˆë‚´

ë‹µë³€ ìŠ¤íƒ€ì¼:
- ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” í†¤
- ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©
- ê°„ê²°í•˜ë©´ì„œë„ ì •ë³´ê°€ í’ë¶€í•œ ë‹µë³€
- í•„ìš”ì‹œ ë¡œê·¸ì¸ ìœ ë„ ë©”ì‹œì§€ í¬í•¨
"""

    if intent == "general":
        enhanced_prompt = f"""
{base_context}

ì‚¬ìš©ì ì§ˆë¬¸: "{user_input}"

PCBë‚˜ ì „ì ë¶€í’ˆ ê´€ë ¨ ì§ˆë¬¸ì´ë¼ë©´ ì¼ë°˜ì ì¸ ì •ë³´ë¥¼ ì œê³µí•˜ê³ ,
ë” ìì„¸í•œ ì •ë³´ë‚˜ ì‹¤ì œ ì¬ê³  ì¡°íšŒê°€ í•„ìš”í•œ ê²½ìš° ë¡œê·¸ì¸ì„ ì•ˆë‚´í•´ì£¼ì„¸ìš”.

ê·¸ ì™¸ì˜ ì§ˆë¬¸ì´ë¼ë©´ PCB-Manager ì„œë¹„ìŠ¤ì™€ ì—°ê´€ì§€ì–´ ì¹œê·¼í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”.
"""
    else:
        enhanced_prompt = f"""
{base_context}

ì‚¬ìš©ìê°€ "{user_input}"ë¼ê³  ë¬¼ì–´ë´¤ìŠµë‹ˆë‹¤.
ì´ëŠ” {intent} ê´€ë ¨ ì§ˆë¬¸ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.

í•´ë‹¹ ì£¼ì œì— ëŒ€í•´ ë„ì›€ì´ ë˜ëŠ” ì •ë³´ë¥¼ ì œê³µí•˜ë˜,
PCB-Manager ì„œë¹„ìŠ¤ì˜ ì¥ì ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì–¸ê¸‰í•´ì£¼ì„¸ìš”.
"""
    
    return enhanced_prompt

# â­ ìˆ˜ì •ëœ ë¶€ë¶„: /chat1/chat ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
@chat1_bp.route("/chat1/chat", methods=["POST", "GET"])
def chat():
    try:
        data = request.get_json()
        messages = data.get("messages", [])
        
        # ìµœì‹  ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ì¶œ
        user_input = next(
            (msg.get("content", "") for msg in reversed(messages) 
             if msg.get("role") == "user"), 
            ""
        )
        
        if not user_input:
            return jsonify({
                "message": {
                    "role": "assistant", 
                    "content": "ì•ˆë…•í•˜ì„¸ìš”! PCB-Manager ì±—ë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š"
                }
            })
        
        # ì‚¬ìš©ì ì˜ë„ ë¶„ì„
        intent = analyze_user_intent(user_input)
        
        # ì„œë¹„ìŠ¤ ì •ë³´ ì œê³µ (ë¡œê·¸ì¸, íšŒì›ê°€ì… ë“±)
        if intent in ["login", "signup", "features", "help", "about"]:
            service_response = get_service_info(intent)
            if service_response:
                return jsonify({
                    "message": {
                        "role": "assistant",
                        "content": service_response
                    }
                })
        
        # PCB ë¶€í’ˆ ì •ë³´ ì œê³µ
        elif intent in ["pcb_info", "size_info"]:
            pcb_response = get_pcb_component_info(user_input)
            return jsonify({
                "message": {
                    "role": "assistant",
                    "content": pcb_response
                }
            })
        
        # ì¼ë°˜ì ì¸ ì§ˆë¬¸ì€ Geminiì—ê²Œ ì „ë‹¬ (í–¥ìƒëœ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©)
        enhanced_prompt = create_enhanced_prompt(user_input, intent)
        response = get_gemini_response(enhanced_prompt)
        
        if not response:
            response = """
ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ˜…

ğŸ”„ **ë‹¤ì‹œ ì‹œë„í•´ë³´ì‹œê±°ë‚˜ ì•„ë˜ ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”:**
- "ê¸°ëŠ¥" ì…ë ¥ â†’ ì„œë¹„ìŠ¤ ê¸°ëŠ¥ ì•ˆë‚´
- "ë¡œê·¸ì¸" ì…ë ¥ â†’ ë¡œê·¸ì¸ ë°©ë²• ì•ˆë‚´  
- "ë„ì›€" ì…ë ¥ â†’ ì „ì²´ ë„ì›€ë§ ë³´ê¸°

ğŸ’¡ **PCB ë¶€í’ˆ ì •ë³´ê°€ í•„ìš”í•˜ì‹œë©´:**
ì €í•­, ì»¤íŒ¨ì‹œí„°, ë‹¤ì´ì˜¤ë“œ ë“±ì˜ ë¶€í’ˆëª…ì„ ì…ë ¥í•´ë³´ì„¸ìš”!
            """
        
        return jsonify({
            "message": {
                "role": "assistant",
                "content": response
            }
        })
        
    except Exception as e:
        print(f"Chat1 API ì˜¤ë¥˜: {str(e)}")
        return jsonify({
            "message": {
                "role": "assistant",
                "content": f"""
ğŸš¨ **ì„œë¹„ìŠ¤ ì¼ì‹œ ì˜¤ë¥˜**

ì£„ì†¡í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.

ğŸ“ **ì§€ì†ì ì¸ ë¬¸ì œ ë°œìƒì‹œ:**
- ì´ë©”ì¼: support@pcb-manager.com
- ì „í™”: 02-1234-5678

ğŸ’¡ **ê¸°ë³¸ ë„ì›€ë§:**
"ë„ì›€", "ê¸°ëŠ¥", "ë¡œê·¸ì¸", "íšŒì›ê°€ì…" ë“±ì„ ì…ë ¥í•´ë³´ì„¸ìš”!
                """
            }
        }), 500